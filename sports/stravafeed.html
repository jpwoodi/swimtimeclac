<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Swim Feed</title>
    <link rel="icon" href="/images/swimming_favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/nav.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f6f9fc;
            color: #1a1f36;
            min-height: 100vh;
            padding: 124px 0 40px;
        }

        .page-header {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px 0;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a1f36;
            letter-spacing: -0.02em;
        }

        .page-header p {
            color: #697386;
            font-size: 15px;
            margin-top: 4px;
        }

        /* Summary stat cards */
        .stats-row {
            display: flex;
            gap: 16px;
            max-width: 1200px;
            margin: 24px auto 0;
            padding: 0 24px;
        }

        .stat-card {
            background: #fff;
            border: 1px solid #e3e8ee;
            border-radius: 8px;
            padding: 20px 24px;
            flex: 1;
            min-width: 0;
        }

        .stat-card .stat-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #697386;
            margin-bottom: 8px;
        }

        .stat-card .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a1f36;
        }

        .stat-card .stat-sub {
            font-size: 13px;
            color: #8792a2;
            margin-top: 4px;
        }

        /* Chart section */
        .chart-section {
            max-width: 1200px;
            margin: 24px auto 0;
            padding: 0 24px;
        }

        .chart-card {
            background: #fff;
            border: 1px solid #e3e8ee;
            border-radius: 8px;
            padding: 24px;
        }

        .chart-card h2 {
            font-size: 15px;
            font-weight: 600;
            color: #1a1f36;
            margin-bottom: 16px;
        }

        .chart-container {
            position: relative;
            height: 260px;
        }

        /* Activity feed */
        .feed-section {
            max-width: 1200px;
            margin: 24px auto 0;
            padding: 0 24px;
        }

        .feed-header {
            font-size: 15px;
            font-weight: 600;
            color: #1a1f36;
            margin-bottom: 12px;
        }

        .feed-card {
            background: #fff;
            border: 1px solid #e3e8ee;
            border-radius: 8px;
            overflow-y: auto;
            max-height: 600px;
        }

        .swim-row {
            display: flex;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #f0f3f7;
            transition: background-color 0.15s ease;
            gap: 16px;
        }

        .swim-row:last-child {
            border-bottom: none;
        }

        .swim-row:hover {
            background-color: #f6f9fc;
        }

        .swim-name {
            flex: 1;
            min-width: 0;
        }

        .swim-name h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1a1f36;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .swim-name .swim-date {
            font-size: 13px;
            color: #8792a2;
            margin-top: 2px;
        }

        .swim-stats {
            display: flex;
            gap: 32px;
            flex-shrink: 0;
        }

        .swim-stat {
            text-align: right;
            min-width: 70px;
        }

        .swim-stat .stat-val {
            font-size: 14px;
            font-weight: 600;
            color: #1a1f36;
        }

        .swim-stat .stat-lbl {
            font-size: 11px;
            color: #8792a2;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .pace-badge {
            display: inline-block;
            background: #e8f5e9;
            color: #2e7d32;
            font-size: 13px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #8792a2;
            font-size: 14px;
        }

        .loading .spinner {
            border: 3px solid #e3e8ee;
            border-top: 3px solid #635bff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-row {
                flex-direction: column;
            }

            .swim-stats {
                gap: 16px;
            }

            .swim-stat {
                min-width: 50px;
            }

            .chart-container {
                height: 200px;
            }

            .swim-row {
                flex-wrap: wrap;
                gap: 8px;
            }

            .swim-stats {
                width: 100%;
                justify-content: space-between;
            }

            .swim-stat {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <button
            class="hamburger"
            type="button"
            aria-label="Toggle navigation menu"
            aria-controls="primary-nav"
            aria-expanded="false"
            onclick="toggleMenu()"
        >
            &#9776;
        </button>
        <ul id="primary-nav">
            <li><a href="/index.html">Home</a></li>
            <li><a href="/work/index.html">Work</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/sports/index.html" class="active">Sports</a></li>
        </ul>
    </nav>
    <nav class="sub-nav">
        <ul>
            <li><a href="/sports/index.html">Overview</a></li>
            <li><a href="/sports/calculator.html">Swim Calculator</a></li>
            <li><a href="/sports/css.html">CSS Calculator</a></li>
            <li><a href="/sports/dash.html">Dashboard</a></li>
            <li><a href="/sports/pools.html">Pool Finder</a></li>
            <li><a href="/sports/stravafeed.html" class="active">Swim Feed</a></li>
            <li><a href="/sports/swim-plan-generator.html">AI Swim Plan</a></li>
            <li><a href="/sports/cyclecommute.html">Cycle Commute</a></li>
        </ul>
    </nav>

    <div class="page-header">
        <h1>Swim Feed</h1>
        <p>Your swimming activity over the last 12 months</p>
    </div>

    <!-- Stats row populated by JS -->
    <div class="stats-row" id="stats-row" style="display: none;"></div>

    <!-- Chart -->
    <div class="chart-section">
        <div class="chart-card">
            <h2>Monthly Distance</h2>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Feed -->
    <div class="feed-section">
        <div class="feed-header">Recent Activity</div>
        <div class="feed-card" id="swim-feed">
            <div class="loading">
                <div class="spinner"></div>
                Loading your swims...
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        function toggleMenu() {
            const toggleBtn = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.top-nav ul');
            const isExpanded = navLinks.classList.toggle('expanded');
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', String(isExpanded));
            }
        }

        function fetchSwims() {
            fetch('/.netlify/functions/get-swims')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('swim-feed').innerHTML = '<div class="loading">Error loading swims.</div>';
                        return;
                    }

                    data.sort((a, b) => new Date(b.start_date_local) - new Date(a.start_date_local));

                    const monthlyData = processMonthlyData(data);
                    const totalDistance = monthlyData.data.reduce((acc, v) => acc + v, 0);
                    const m25Length = 188.3;
                    const timesAroundM25 = (totalDistance / m25Length).toFixed(1);
                    const totalSessions = data.length;
                    const avgDistance = totalSessions > 0 ? (totalDistance / totalSessions).toFixed(1) : 0;

                    // Render stats
                    const statsRow = document.getElementById('stats-row');
                    statsRow.style.display = 'flex';
                    statsRow.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-label">Total Distance</div>
                            <div class="stat-value">${totalDistance.toFixed(1)} km</div>
                            <div class="stat-sub">${timesAroundM25}x around the M25</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Sessions</div>
                            <div class="stat-value">${totalSessions}</div>
                            <div class="stat-sub">Last 12 months</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg per Session</div>
                            <div class="stat-value">${avgDistance} km</div>
                        </div>
                    `;

                    renderChart(monthlyData);

                    // Render swim rows
                    const feedEl = document.getElementById('swim-feed');
                    feedEl.innerHTML = '';
                    if (data.length === 0) {
                        feedEl.innerHTML = '<div class="loading">No swim activity found yet.</div>';
                        return;
                    }

                    data.forEach(swim => {
                        const pace = calculatePacePer100m(swim.average_speed);
                        const date = new Date(swim.start_date_local);
                        const dateStr = date.toLocaleDateString('en-GB', {
                            day: 'numeric', month: 'short', year: 'numeric'
                        });

                        const row = document.createElement('div');
                        row.className = 'swim-row';
                        row.innerHTML = `
                            <div class="swim-name">
                                <h4>${swim.name}</h4>
                                <div class="swim-date">${dateStr}</div>
                            </div>
                            <div class="swim-stats">
                                <div class="swim-stat">
                                    <div class="stat-val">${swim.distance.toLocaleString()}m</div>
                                    <div class="stat-lbl">Distance</div>
                                </div>
                                <div class="swim-stat">
                                    <div class="stat-val">${formatDuration(swim.moving_time)}</div>
                                    <div class="stat-lbl">Duration</div>
                                </div>
                                <div class="swim-stat">
                                    <span class="pace-badge">${pace}/100m</span>
                                </div>
                            </div>
                        `;
                        feedEl.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching swims:', error);
                    document.getElementById('swim-feed').innerHTML =
                        '<div class="loading">Something went wrong. Please try again later.</div>';
                });
        }

        function calculatePacePer100m(averageSpeed) {
            if (!averageSpeed || averageSpeed === 0) return 'N/A';
            const paceSecs = 100 / averageSpeed;
            const mins = Math.floor(paceSecs / 60);
            const secs = Math.round(paceSecs % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }

        function formatDuration(timeInSeconds) {
            const hours = Math.floor(timeInSeconds / 3600);
            const minutes = Math.floor((timeInSeconds % 3600) / 60);
            const seconds = timeInSeconds % 60;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m ${seconds}s`;
        }

        function processMonthlyData(swims) {
            const monthlyTotals = {};
            swims.forEach(swim => {
                const date = new Date(swim.start_date_local);
                const key = `${date.getFullYear()}-${date.getMonth() + 1}`;
                monthlyTotals[key] = (monthlyTotals[key] || 0) + swim.distance / 1000;
            });

            const labels = [];
            const dataPoints = [];
            const now = new Date();
            for (let i = 11; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${d.getMonth() + 1}`;
                labels.push(d.toLocaleString('default', { month: 'short' }));
                dataPoints.push(parseFloat((monthlyTotals[key] || 0).toFixed(1)));
            }
            return { labels, data: dataPoints };
        }

        function renderChart(monthlyData) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');

            // Stripe-inspired gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 260);
            gradient.addColorStop(0, 'rgba(99, 91, 255, 0.2)');
            gradient.addColorStop(1, 'rgba(99, 91, 255, 0)');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        data: monthlyData.data,
                        backgroundColor: 'rgba(99, 91, 255, 0.75)',
                        borderColor: 'rgba(99, 91, 255, 1)',
                        borderWidth: 0,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1f36',
                            titleFont: { family: 'Inter', weight: '600' },
                            bodyFont: { family: 'Inter' },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => `${ctx.parsed.y} km`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { family: 'Inter', size: 12 },
                                color: '#8792a2',
                            },
                            border: { display: false }
                        },
                        y: {
                            grid: {
                                color: '#f0f3f7',
                                drawBorder: false,
                            },
                            ticks: {
                                font: { family: 'Inter', size: 12 },
                                color: '#8792a2',
                                callback: (v) => v + ' km'
                            },
                            border: { display: false },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchSwims();
        });
    </script>
</body>
</html>
