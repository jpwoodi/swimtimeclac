<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swim Plan Generator</title>
    <link rel="icon" href="/images/swimming_favicon.ico">
    <meta name="description" content="Generate personalised AI-powered swim training plans based on your Critical Swim Speed.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/nav.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f6f9fc;
            color: #1a1f36;
            min-height: 100vh;
            padding: 124px 0 60px;
        }

        .page-header {
            max-width: 600px;
            margin: 0 auto;
            padding: 32px 24px 0;
            text-align: center;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #1a1f36;
        }

        .page-header p {
            color: #697386;
            font-size: 15px;
            margin-top: 4px;
        }

        .form-card {
            background: #fff;
            border: 1px solid #e3e8ee;
            border-radius: 8px;
            max-width: 600px;
            margin: 24px auto 0;
            padding: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #697386;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 6px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e3e8ee;
            border-radius: 6px;
            font-size: 15px;
            font-family: inherit;
            color: #1a1f36;
            transition: border-color 0.15s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #635bff;
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .input-row input { flex: 1; }

        button {
            width: 100%;
            padding: 12px;
            background-color: #635bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        button:hover { background-color: #5851ea; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .spinner {
            border: 3px solid #e3e8ee;
            border-top: 3px solid #635bff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: #8792a2;
            font-size: 14px;
        }

        /* Results */
        .results-card {
            background: #fff;
            border: 1px solid #e3e8ee;
            border-radius: 8px;
            max-width: 1200px;
            margin: 24px auto 0;
            padding: 24px;
            display: none;
            overflow-x: auto;
        }

        .results-card h2 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1f36;
            margin-bottom: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            font-size: 13px;
        }

        th {
            background-color: #f6f9fc;
            color: #697386;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            border-bottom: 1px solid #e3e8ee;
        }

        td {
            color: #1a1f36;
            border-bottom: 1px solid #f0f3f7;
        }

        tr:hover td {
            background-color: #f6f9fc;
        }

        /* Comment section */
        .comment-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e3e8ee;
            display: none;
        }

        .comment-section textarea {
            resize: vertical;
            min-height: 80px;
        }

        .comment-section button {
            margin-top: 12px;
        }

        @media (max-width: 768px) {
            .form-card, .results-card { margin: 24px 16px 0; }
            .page-header h1 { font-size: 22px; }
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="hamburger" onclick="toggleMenu()">&#9776;</div>
        <ul>
            <li><a href="/index.html">Home</a></li>
            <li><a href="/work/index.html">Work</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/sports/index.html" class="active">Sports</a></li>
        </ul>
    </nav>
    <nav class="sub-nav">
        <ul>
            <li><a href="/sports/index.html">Overview</a></li>
            <li><a href="/sports/calculator.html">Swim Calculator</a></li>
            <li><a href="/sports/css.html">CSS Calculator</a></li>
            <li><a href="/sports/dash.html">Dashboard</a></li>
            <li><a href="/sports/pools.html">Pool Finder</a></li>
            <li><a href="/sports/stravafeed.html">Swim Feed</a></li>
            <li><a href="/sports/swim-plan-generator.html" class="active">AI Swim Plan</a></li>
            <li><a href="/sports/cyclecommute.html">Cycle Commute</a></li>
        </ul>
    </nav>

    <div class="page-header">
        <h1>AI Swim Plan</h1>
        <p>Generate a personalised training plan powered by AI</p>
    </div>

    <div class="form-card">
        <form id="swim-plan-form">
            <div class="form-group">
                <label for="goal">Swim Goal</label>
                <input type="text" id="goal" name="goal" placeholder="e.g. Improve endurance, build speed">
            </div>
            <div class="form-group">
                <label>Critical Swim Speed (per 100m)</label>
                <div class="input-row">
                    <input type="number" id="cssMinutes" name="cssMinutes" placeholder="Min" min="0">
                    <input type="number" id="cssSeconds" name="cssSeconds" placeholder="Sec" min="0" max="59">
                </div>
            </div>
            <div class="form-group">
                <label for="duration">Plan Duration (weeks)</label>
                <input type="number" id="duration" name="duration" placeholder="e.g. 4">
            </div>
            <div class="form-group">
                <label for="sessions">Sessions per Week</label>
                <input type="number" id="sessions" name="sessions" placeholder="e.g. 3">
            </div>
            <div class="form-group">
                <label for="session-duration">Session Duration (minutes)</label>
                <input type="number" id="session-duration" name="session-duration" placeholder="e.g. 60">
            </div>
            <button type="button" onclick="generateSwimPlan()">Generate Plan</button>
        </form>
    </div>

    <div id="loading-spinner" class="loading">
        <div class="spinner"></div>
        <p>Generating your plan...</p>
    </div>

    <div class="results-card" id="results-container">
        <h2>Your Swim Plan</h2>
        <table id="swim-plan-table"></table>

        <div class="comment-section" id="comment-section">
            <div class="form-group">
                <label for="comments">Refine your plan</label>
                <textarea id="comments" name="comments" placeholder="e.g. Make the sessions longer, add more drills" rows="3"></textarea>
            </div>
            <button type="button" onclick="addComment()">Regenerate Plan</button>
        </div>
    </div>

    <script>
        function toggleMenu() {
            const navMenu = document.querySelector('.top-nav ul');
            navMenu.classList.toggle('expanded');
        }

        let swimPlans = [];
        let conversationHistory = [];
        let storedDetails = {};

        async function generateSwimPlan() {
            const goal = document.getElementById('goal').value;
            const cssMinutes = document.getElementById('cssMinutes').value;
            const cssSeconds = document.getElementById('cssSeconds').value;
            const duration = document.getElementById('duration').value;
            const sessions = document.getElementById('sessions').value;
            const sessionDuration = document.getElementById('session-duration').value;

            if (!goal || !cssMinutes || !cssSeconds || !duration || !sessions || !sessionDuration) {
                alert("Please fill out all fields.");
                return;
            }

            storedDetails = { goal, cssMinutes, cssSeconds, duration, sessions, sessionDuration };

            await fetchAndDisplayPlan({
                ...storedDetails,
                comments: "",
                conversationHistory: []
            });

            document.getElementById('comment-section').style.display = 'block';
        }

        async function addComment() {
            const comments = document.getElementById('comments').value;
            if (!comments.trim()) {
                alert("Please enter a comment to modify the plan.");
                return;
            }

            await fetchAndDisplayPlan({
                ...storedDetails,
                conversationHistory,
                comments
            });

            document.getElementById('comments').value = '';
        }

        async function fetchAndDisplayPlan(details) {
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('comment-section').style.display = 'none';
            document.getElementById('loading-spinner').style.display = 'block';

            try {
                const response = await fetch('/.netlify/functions/generateSwimPlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(details)
                });

                const data = await response.json();

                if (response.ok) {
                    swimPlans = parseSwimPlan(data.plan);
                    document.getElementById('loading-spinner').style.display = 'none';
                    displayAllWeeks();
                    document.getElementById('results-container').style.display = 'block';
                    document.getElementById('comment-section').style.display = 'block';
                    conversationHistory = data.conversationHistory;
                } else {
                    console.error('Backend error:', data.error);
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            } finally {
                document.getElementById('loading-spinner').style.display = 'none';
            }
        }

        function parseSwimPlan(planText) {
            const weeklyPlans = [];
            const lines = planText.split('\n').filter(line => line.trim() !== '');
            let currentWeekNumber = null;
            let currentWeekSessions = [];

            lines.forEach((line, index) => {
                if (index < 2) return;
                const parts = line.split('|').map(part => part.trim()).filter(part => part !== '');

                if (parts.length === 7) {
                    const [weekStr, sessionStr, ...sessionData] = parts;
                    const weekNumber = parseInt(weekStr);
                    const sessionNumber = parseInt(sessionStr);

                    if (currentWeekNumber !== weekNumber) {
                        if (currentWeekNumber !== null) {
                            weeklyPlans.push({ weekNumber: currentWeekNumber, sessions: currentWeekSessions });
                        }
                        currentWeekNumber = weekNumber;
                        currentWeekSessions = [];
                    }
                    currentWeekSessions.push({ sessionNumber, sessionData });
                }
            });

            if (currentWeekNumber !== null) {
                weeklyPlans.push({ weekNumber: currentWeekNumber, sessions: currentWeekSessions });
            }
            return weeklyPlans;
        }

        function displayAllWeeks() {
            const table = document.getElementById('swim-plan-table');
            let html = `
                <thead><tr>
                    <th>Week</th><th>Session</th><th>Warm Up</th>
                    <th>Build Set</th><th>Main Set</th><th>Cool Down</th><th>Total</th>
                </tr></thead><tbody>`;

            swimPlans.forEach(week => {
                week.sessions.forEach(session => {
                    const d = session.sessionData;
                    if (d.length === 5) {
                        html += `<tr>
                            <td>Week ${week.weekNumber}</td>
                            <td>${session.sessionNumber}</td>
                            <td>${d[0]}</td><td>${d[1]}</td><td>${d[2]}</td>
                            <td>${d[3]}</td><td>${d[4]}</td>
                        </tr>`;
                    }
                });
            });

            html += `</tbody>`;
            table.innerHTML = html;
        }
    </script>
</body>
</html>
