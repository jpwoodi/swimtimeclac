<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycle Commute Dashboard</title>
    <link rel="icon" href="/images/swimming_favicon.ico">
    <meta name="description" content="Track your cycle commute data with distance, speed, and savings charts.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/nav.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f6f9fc;
            color: #1a1f36;
            min-height: 100vh;
            padding: 124px 0 60px;
        }

        .page-header {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px 0;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #1a1f36;
        }

        .page-header p {
            color: #697386;
            font-size: 15px;
            margin-top: 4px;
        }

        .controls {
            max-width: 1200px;
            margin: 16px auto 0;
            padding: 0 24px;
        }

        .controls button {
            padding: 10px 20px;
            background-color: #635bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .controls button:hover { background-color: #5851ea; }

        /* Stats row */
        .stats-row {
            display: flex;
            gap: 16px;
            max-width: 1200px;
            margin: 16px auto 0;
            padding: 0 24px;
        }

        .stat-card {
            background: #fff;
            border: 1px solid #e3e8ee;
            border-radius: 8px;
            padding: 20px 24px;
            flex: 1;
            min-width: 0;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #697386;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a1f36;
        }

        .stat-sub {
            font-size: 13px;
            color: #8792a2;
            margin-top: 4px;
        }

        /* Filter Bar */
        .filter-bar {
            max-width: 1200px;
            margin: 16px auto 0;
            padding: 16px 24px;
            background: #fff;
            border: 1px solid #e3e8ee;
            border-radius: 8px;
            display: flex;
            gap: 24px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-pill {
            padding: 6px 16px;
            background: #f6f9fc;
            color: #697386;
            border: 1px solid #e3e8ee;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-pill:hover {
            background: #e3e8ee;
        }

        .filter-pill.active {
            background: #635bff;
            color: #fff;
            border-color: #635bff;
        }

        .filter-toggle {
            padding: 6px 14px;
            background: transparent;
            color: #697386;
            border: 1px solid #e3e8ee;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-toggle:hover {
            border-color: #635bff;
            color: #635bff;
        }

        .filter-toggle.active {
            background: #635bff;
            color: #fff;
            border-color: #635bff;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #8792a2;
            font-size: 14px;
        }

        .loading .spinner {
            border: 3px solid #e3e8ee;
            border-top: 3px solid #635bff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Charts */
        .charts-section {
            max-width: 1200px;
            margin: 24px auto 0;
            padding: 0 24px;
        }

        .chart-grid-row1 {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .chart-grid-row2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .chart-card {
            background: #fff;
            border: 1px solid #e3e8ee;
            border-radius: 8px;
            padding: 24px;
        }

        .chart-card-wide {
            grid-column: span 1;
        }

        .chart-card-full {
            grid-column: span 1;
        }

        .chart-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: #697386;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 12px;
        }

        .chart-container {
            position: relative;
            height: 260px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid #e3e8ee;
            padding-bottom: 8px;
        }

        .tab-btn {
            padding: 6px 12px;
            background: transparent;
            color: #697386;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab-btn:hover {
            color: #1a1f36;
        }

        .tab-btn.active {
            color: #635bff;
            border-bottom-color: #635bff;
        }

        /* Insights */
        .insights {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #f0f3f7;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #697386;
            line-height: 1.5;
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-bullet {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-top: 6px;
            flex-shrink: 0;
        }

        .insight-bullet.blue {
            background-color: #635bff;
        }

        .insight-bullet.green {
            background-color: #2e7d32;
        }

        .insight-bullet.teal {
            background-color: #009688;
        }

        /* Commute table */
        .table-section {
            max-width: 1200px;
            margin: 24px auto 0;
            padding: 0 24px;
        }

        .table-card {
            background: #fff;
            border: 1px solid #e3e8ee;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: #697386;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 20px 24px 0;
            margin-bottom: 12px;
        }

        .table-scroll {
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 16px;
            text-align: left;
            font-size: 13px;
        }

        th {
            background-color: #f6f9fc;
            color: #697386;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            position: sticky;
            top: 0;
            border-bottom: 1px solid #e3e8ee;
        }

        td {
            color: #1a1f36;
            border-bottom: 1px solid #f0f3f7;
        }

        tr:hover td {
            background-color: #f6f9fc;
        }

        .status-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .status-tag.morning { background-color: #635bff; }
        .status-tag.evening { background-color: #2e7d32; }
        .status-tag.other { background-color: #8792a2; }

        /* Time Summary Styles (replaces Box Plots) */
        .time-summary {
            padding: 16px 0;
        }

        .kpi-row {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
        }

        .kpi-item {
            flex: 1;
        }

        .kpi-label {
            font-size: 11px;
            font-weight: 600;
            color: #8792a2;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1f36;
            font-variant-numeric: tabular-nums;
        }

        .primary-stat {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            font-size: 15px;
            color: #697386;
        }

        .primary-stat strong {
            color: #1a1f36;
            font-size: 18px;
        }

        .streak-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: help;
            transition: transform 0.1s ease;
        }

        .streak-badge:hover {
            transform: scale(1.05);
        }

        .streak-badge-green {
            background-color: #c8e6c9;
            color: #2e7d32;
        }

        .streak-badge-amber {
            background-color: #ffe0b2;
            color: #ef6c00;
        }

        .streak-badge-grey {
            background-color: #e3e8ee;
            color: #697386;
        }

        .target-visual {
            margin-bottom: 16px;
            padding: 20px 0;
        }

        .time-bar {
            position: relative;
            height: 40px;
            background: linear-gradient(to right, #f0f3f7 0%, #f0f3f7 100%);
            border-radius: 8px;
            padding: 0 20px;
        }

        .time-tick {
            position: absolute;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .time-label {
            position: absolute;
            top: 45px;
            font-size: 11px;
            color: #8792a2;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        .target-tick .target-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 40px;
            background: #635bff;
            border-left: 2px dashed #635bff;
        }

        .target-label {
            color: #635bff;
            font-weight: 600;
        }

        .avg-dot {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .supporting-line {
            font-size: 13px;
            color: #697386;
            text-align: center;
        }

        /* Heatmap Styles */
        #heatmapContainer {
            padding: 8px 0;
        }

        .heatmap-header {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
            font-size: 10px;
            font-weight: 600;
            color: #8792a2;
            text-align: center;
        }

        .heatmap-row {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 2px;
        }

        .heatmap-week-label {
            font-size: 10px;
            color: #8792a2;
            padding: 4px;
            display: flex;
            align-items: center;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            cursor: pointer;
            transition: transform 0.1s ease;
            min-height: 16px;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
        }

        .heatmap-cell.level-0 { background-color: #f0f3f7; }
        .heatmap-cell.level-1 { background-color: #c8e6c9; }
        .heatmap-cell.level-2 { background-color: #81c784; }
        .heatmap-cell.level-3 { background-color: #4caf50; }
        .heatmap-cell.level-4 { background-color: #2e7d32; }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 12px;
            font-size: 10px;
            color: #8792a2;
        }

        .heatmap-legend-item {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        @media (max-width: 1024px) {
            .chart-grid-row1 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-row { flex-direction: column; }
            .chart-grid-row1 { grid-template-columns: 1fr; }
            .chart-grid-row2 { grid-template-columns: 1fr; }
            .chart-container { height: 200px; }
            .filter-bar { flex-direction: column; align-items: flex-start; }
        }
    </style>
    <script src="/auth.js"></script>
</head>
<body>
    <nav class="top-nav">
        <div class="hamburger" onclick="toggleMenu()">&#9776;</div>
        <ul>
            <li><a href="/index.html">Home</a></li>
            <li><a href="/work/index.html">Work</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/sports/index.html" class="active">Sports</a></li>
        </ul>
    </nav>
    <nav class="sub-nav">
        <ul>
            <li><a href="/sports/index.html">Overview</a></li>
            <li><a href="/sports/calculator.html">Swim Calculator</a></li>
            <li><a href="/sports/css.html">CSS Calculator</a></li>
            <li><a href="/sports/dash.html">Dashboard</a></li>
            <li><a href="/sports/pools.html">Pool Finder</a></li>
            <li><a href="/sports/stravafeed.html">Swim Feed</a></li>
            <li><a href="/sports/swim-plan-generator.html">AI Swim Plan</a></li>
            <li><a href="/sports/cyclecommute.html" class="active">Cycle Commute</a></li>
        </ul>
    </nav>

    <div class="page-header">
        <h1>Cycle Commute</h1>
        <p>Your cycle commute data and savings</p>
    </div>

    <div class="controls">
        <button id="refresh-btn">Refresh from Strava</button>
    </div>

    <div id="loading-area" class="loading" style="display:none;">
        <div class="spinner"></div>
        Loading commute data...
    </div>

    <div class="stats-row" id="stats-row" style="display:none;"></div>

    <!-- Filter Bar -->
    <div class="filter-bar" id="filter-bar" style="display:none;">
        <div class="filter-group">
            <button class="filter-pill active" data-filter="all">All</button>
            <button class="filter-pill" data-filter="morning">Morning</button>
            <button class="filter-pill" data-filter="evening">Evening</button>
        </div>
        <div class="filter-group">
            <button class="filter-toggle" data-toggle="weekdays">Weekdays only</button>
            <button class="filter-toggle" data-toggle="last90">Last 90 days</button>
        </div>
    </div>

    <div class="charts-section">
        <!-- Row 1: Leave/Arrival Times, Scatter, Heatmap -->
        <div class="chart-grid-row1">
            <div class="chart-card chart-card-wide">
                <h3>Leave & Arrival Times</h3>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="morning">Morning Rides</button>
                    <button class="tab-btn" data-tab="evening">Evening Rides</button>
                </div>
                <div class="chart-container" style="height: 320px;">
                    <div id="boxPlotContainer"></div>
                </div>
                <div class="insights" id="boxPlotInsights"></div>
            </div>
            <div class="chart-card">
                <h3>Leave Time vs Duration</h3>
                <div class="chart-container" style="height: 320px;">
                    <canvas id="scatterChart"></canvas>
                </div>
                <div class="insights" id="scatterInsights"></div>
            </div>
            <div class="chart-card">
                <h3>Weekly Commute Pattern</h3>
                <div class="chart-container" style="height: 320px; overflow-y: auto;">
                    <div id="heatmapContainer"></div>
                </div>
                <div class="insights" id="heatmapInsights"></div>
            </div>
        </div>

        <!-- Row 2: Speed Over Time -->
        <div class="chart-grid-row2">
            <div class="chart-card chart-card-full">
                <h3>Speed Over Time</h3>
                <div class="chart-container" style="height: 280px;">
                    <canvas id="speedTimeChart"></canvas>
                </div>
                <div class="insights" id="speedInsights"></div>
            </div>
        </div>
    </div>

    <div class="table-section">
        <div class="table-card">
            <h3>All Commutes</h3>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Distance</th>
                            <th>Time</th>
                            <th>Avg Speed</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody id="commute-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function toggleMenu() {
            const navMenu = document.querySelector('.top-nav ul');
            navMenu.classList.toggle('expanded');
        }

        const CHART_COLORS = {
            green: 'rgba(46, 125, 50, 0.75)',
            purple: 'rgba(99, 91, 255, 0.75)',
            teal: 'rgba(0, 150, 136, 0.75)',
            orange: 'rgba(239, 108, 0, 0.75)',
            gridLine: '#f0f3f7',
            tick: '#8792a2',
        };
        const COMMUTES_ENDPOINT = '/.netlify/functions/get-rides';

        // Global state
        let allRides = [];
        let normalizedRides = [];
        let filters = {
            type: 'all', // all, morning, evening
            weekdaysOnly: false,
            last90Days: false
        };
        let currentBoxPlotTab = 'morning';
        let chartInstances = {};

        document.getElementById('refresh-btn').addEventListener('click', fetchCommutes);

        // Setup filter event listeners
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                filters.type = btn.dataset.filter;
                applyFiltersAndRender();
            });
        });

        document.querySelectorAll('.filter-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                const toggle = btn.dataset.toggle;
                if (toggle === 'weekdays') {
                    filters.weekdaysOnly = btn.classList.contains('active');
                } else if (toggle === 'last90') {
                    filters.last90Days = btn.classList.contains('active');
                }
                applyFiltersAndRender();
            });
        });

        // Tab switching for box plots
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentBoxPlotTab = btn.dataset.tab;
                renderBoxPlot(getFilteredRides());
            });
        });

        // Data normalization function
        function normalizeRide(ride) {
            // Parse date in Europe/London timezone
            const startLocal = new Date(ride.start_date_local);
            const durationSec = ride.moving_time || ride.elapsed_time;
            const endLocal = new Date(startLocal.getTime() + durationSec * 1000);

            // Extract time components
            const leaveMinutes = startLocal.getHours() * 60 + startLocal.getMinutes();
            const arriveMinutes = endLocal.getHours() * 60 + endLocal.getMinutes();

            // Classify commute type
            const hour = startLocal.getHours();
            let commuteType = 'other';
            if (hour >= 4 && hour < 12) {
                commuteType = 'morning';
            } else if (hour >= 15 && hour < 23) {
                commuteType = 'evening';
            }

            // Day of week (0 = Monday, 6 = Sunday)
            const dayOfWeek = (startLocal.getDay() + 6) % 7;

            // ISO week calculation
            const yearWeekKey = getISOWeek(startLocal);

            return {
                ...ride,
                startLocal,
                endLocal,
                leaveMinutes,
                arriveMinutes,
                distanceKm: ride.distance / 1000,
                durationSec,
                durationMin: durationSec / 60,
                avgSpeedKph: (ride.average_speed || (ride.distance / durationSec)) * 3.6,
                commuteType,
                dayOfWeek,
                yearWeekKey
            };
        }

        // Get ISO week number
        function getISOWeek(date) {
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            const weekNumber = 1 + Math.ceil((firstThursday - target) / 604800000);
            return `${target.getFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
        }

        // Apply filters and re-render
        function applyFiltersAndRender() {
            const filtered = getFilteredRides();
            renderStats(filtered);
            renderAllCharts(filtered);
            renderTable(filtered);
        }

        // Get filtered rides
        function getFilteredRides() {
            let filtered = [...normalizedRides];

            // Filter by type
            if (filters.type !== 'all') {
                filtered = filtered.filter(r => r.commuteType === filters.type);
            }

            // Filter weekdays only
            if (filters.weekdaysOnly) {
                filtered = filtered.filter(r => r.dayOfWeek < 5);
            }

            // Filter last 90 days
            if (filters.last90Days) {
                const ninetyDaysAgo = new Date();
                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                filtered = filtered.filter(r => r.startLocal >= ninetyDaysAgo);
            }

            return filtered;
        }

        async function parseJsonResponse(response) {
            const raw = await response.text();
            try {
                return JSON.parse(raw);
            } catch {
                throw new Error(`Non-JSON response from server (${response.status}): ${raw.slice(0, 120)}`);
            }
        }

        async function fetchCommutes() {
            const loading = document.getElementById('loading-area');
            loading.style.display = 'block';
            loading.innerHTML = '<div class="spinner"></div>Loading commute data...';

            try {
                const response = await fetch(COMMUTES_ENDPOINT);
                const data = await parseJsonResponse(response);

                if (!response.ok || data.error) {
                    const msg = data && data.error ? data.error : 'Error loading commute data.';
                    throw new Error(msg);
                }

                if (!Array.isArray(data)) {
                    throw new Error('Unexpected commute payload format.');
                }

                loading.style.display = 'none';

                // Store and normalize data
                allRides = data.sort((a, b) => new Date(b.start_date_local) - new Date(a.start_date_local));
                normalizedRides = allRides.map(normalizeRide);

                // Show filter bar
                document.getElementById('filter-bar').style.display = 'flex';

                // Render everything
                applyFiltersAndRender();
            } catch (err) {
                console.error('Error:', err);
                loading.innerHTML = `<p>Something went wrong: ${err.message}</p>`;
            }
        }

        function renderStats(rides) {
            const totalDist = rides.reduce((t, r) => t + r.distanceKm, 0);
            const totalRides = rides.length;
            const tubeCostPerTrip = 2.80;
            const savings = (totalRides * tubeCostPerTrip).toFixed(2);

            // Calculate weeks cycling (unique weeks)
            const uniqueWeeks = new Set(rides.map(r => r.yearWeekKey));
            const weeksCycling = uniqueWeeks.size;

            const row = document.getElementById('stats-row');
            row.style.display = 'flex';
            row.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Distance</div>
                    <div class="stat-value">${totalDist.toFixed(1)} km</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Rides</div>
                    <div class="stat-value">${totalRides}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tube Savings</div>
                    <div class="stat-value">&pound;${savings}</div>
                    <div class="stat-sub">vs. &pound;${tubeCostPerTrip}/trip</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Weeks Cycling</div>
                    <div class="stat-value">${weeksCycling}</div>
                </div>
            `;
        }

        // Render all charts
        function renderAllCharts(rides) {
            renderBoxPlot(rides);
            renderScatterChart(rides);
            renderHeatmap(rides);
            renderSpeedOverTime(rides);
        }

        // Utility: format time from minutes since midnight
        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = Math.round(minutes % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // Utility: calculate circular mean for times (handles wraparound at midnight)
        function calculateCircularMean(minutesArray) {
            if (minutesArray.length === 0) return null;

            // Convert to angles (0-1440 minutes -> 0-2π radians)
            const angles = minutesArray.map(m => (2 * Math.PI * m) / 1440);

            // Calculate mean of sines and cosines
            const meanSin = angles.reduce((sum, a) => sum + Math.sin(a), 0) / angles.length;
            const meanCos = angles.reduce((sum, a) => sum + Math.cos(a), 0) / angles.length;

            // Calculate mean angle
            let meanAngle = Math.atan2(meanSin, meanCos);

            // Convert back to minutes (0-1440)
            let meanMinutes = (meanAngle * 1440) / (2 * Math.PI);
            if (meanMinutes < 0) meanMinutes += 1440;

            return meanMinutes;
        }

        // Get rides for last N days
        function getRidesLastNDays(rides, days) {
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            return rides.filter(r => r.startLocal >= cutoff);
        }

        // Calculate streak for "Leave by 08:00" target
        function calculateLeaveBy08Streak(rides) {
            const TARGET_TIME = 480; // 08:00 in minutes

            // Get morning rides only
            const morningRides = rides.filter(r => r.commuteType === 'morning');
            if (morningRides.length === 0) return { streak: null, last10: null };

            // Group by date (YYYY-MM-DD) and find earliest leave time per day
            const dayMap = {};
            morningRides.forEach(r => {
                const dateKey = r.startLocal.toISOString().split('T')[0];
                if (!dayMap[dateKey] || r.leaveMinutes < dayMap[dateKey]) {
                    dayMap[dateKey] = r.leaveMinutes;
                }
            });

            // Get sorted array of morning commute-days (most recent first)
            const sortedDays = Object.keys(dayMap).sort().reverse();

            // Calculate streak from most recent day backwards
            let streak = 0;
            for (const day of sortedDays) {
                if (dayMap[day] <= TARGET_TIME) {
                    streak++;
                } else {
                    break; // Streak broken
                }
            }

            // Calculate last 10 morning commute-days on-time count
            const last10Days = sortedDays.slice(0, 10);
            const last10OnTime = last10Days.filter(day => dayMap[day] <= TARGET_TIME).length;

            return { streak, last10: { onTime: last10OnTime, total: last10Days.length } };
        }

        // CHART 1: Leave & Arrival Times - Last 30 Days Summary
        function renderBoxPlot(rides) {
            const container = document.getElementById('boxPlotContainer');
            const insightsDiv = document.getElementById('boxPlotInsights');

            // ALWAYS constrain to last 30 days for this component
            const last30DaysRides = getRidesLastNDays(rides, 30);
            const typeRides = last30DaysRides.filter(r => r.commuteType === currentBoxPlotTab);

            if (typeRides.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#8792a2;padding:40px;">No rides in the last 30 days</p>';
                insightsDiv.innerHTML = '';
                return;
            }

            const leaveTimes = typeRides.map(r => r.leaveMinutes);
            const arriveTimes = typeRides.map(r => r.arriveMinutes);

            const avgLeave = calculateCircularMean(leaveTimes);
            const avgArrive = calculateCircularMean(arriveTimes);

            if (currentBoxPlotTab === 'morning') {
                // Morning Tab: KPIs + Leave by 08:00 stat + Target visual + Streak badge

                // Calculate Leave by 08:00 percentage
                const onTimeCount = leaveTimes.filter(t => t <= 480).length;
                const onTimePct = Math.round((onTimeCount / leaveTimes.length) * 100);

                // Calculate streak
                const streakData = calculateLeaveBy08Streak(last30DaysRides);

                // Determine color for target visual
                let targetColor = '#2e7d32'; // green
                if (avgLeave > 480 && avgLeave <= 490) {
                    targetColor = '#ef6c00'; // amber
                } else if (avgLeave > 490) {
                    targetColor = '#d32f2f'; // red
                }

                // Determine streak badge color
                let streakBadgeClass = 'streak-badge-grey';
                if (streakData.streak && streakData.streak >= 5) {
                    streakBadgeClass = 'streak-badge-green';
                } else if (streakData.streak && streakData.streak >= 1) {
                    streakBadgeClass = 'streak-badge-amber';
                }

                container.innerHTML = `
                    <div class="time-summary">
                        <div class="kpi-row">
                            <div class="kpi-item">
                                <div class="kpi-label">Average Leave Time</div>
                                <div class="kpi-value">${avgLeave !== null ? formatTime(avgLeave) : '—'}</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Average Arrive Time</div>
                                <div class="kpi-value">${avgArrive !== null ? formatTime(avgArrive) : '—'}</div>
                            </div>
                        </div>

                        <div class="primary-stat">
                            <span class="stat-text">Leave by 08:00: <strong>${onTimePct}%</strong></span>
                            <span class="streak-badge ${streakBadgeClass}" title="Counts consecutive commute-days where your earliest morning ride left by 08:00. Days without a morning ride don't break the streak.">
                                Streak: ${streakData.streak !== null ? streakData.streak : '—'} ${streakData.streak === 1 ? 'day' : 'days'}
                            </span>
                        </div>

                        <div class="target-visual">
                            <div class="time-bar">
                                <div class="time-tick" style="left: 0%;">
                                    <span class="time-label">06:00</span>
                                </div>
                                <div class="time-tick target-tick" style="left: 50%;">
                                    <span class="target-line"></span>
                                    <span class="time-label target-label">Target 08:00</span>
                                </div>
                                <div class="time-tick" style="left: 100%;">
                                    <span class="time-label">10:00</span>
                                </div>
                                ${avgLeave !== null ? `<div class="avg-dot" style="left: ${((avgLeave - 360) / 240) * 100}%; background-color: ${targetColor};"></div>` : ''}
                            </div>
                        </div>

                        ${streakData.last10 && streakData.last10.total > 0 ? `
                            <div class="supporting-line">
                                Last ${streakData.last10.total} morning commute-days: ${streakData.last10.onTime}/${streakData.last10.total} on time
                            </div>
                        ` : ''}
                    </div>
                `;

                insightsDiv.innerHTML = '';

            } else {
                // Evening Tab: KPIs + Optional insight

                container.innerHTML = `
                    <div class="time-summary">
                        <div class="kpi-row">
                            <div class="kpi-item">
                                <div class="kpi-label">Average Leave Time</div>
                                <div class="kpi-value">${avgLeave !== null ? formatTime(avgLeave) : '—'}</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Average Arrive Time</div>
                                <div class="kpi-value">${avgArrive !== null ? formatTime(avgArrive) : '—'}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Optional insight: compare evening vs morning speeds
                const morningRides = last30DaysRides.filter(r => r.commuteType === 'morning');
                if (morningRides.length > 0 && typeRides.length > 0) {
                    const avgMorningDuration = morningRides.reduce((sum, r) => sum + r.durationMin, 0) / morningRides.length;
                    const avgEveningDuration = typeRides.reduce((sum, r) => sum + r.durationMin, 0) / typeRides.length;
                    const diff = Math.round(((avgEveningDuration - avgMorningDuration) / avgMorningDuration) * 100);
                    const comparison = diff < 0 ? 'faster' : 'slower';
                    insightsDiv.innerHTML = `<div class="insight-item"><span class="insight-bullet green"></span><span>Evening rides are ${Math.abs(diff)}% ${comparison} (last 30 days)</span></div>`;
                } else {
                    insightsDiv.innerHTML = '';
                }
            }
        }

        // CHART 2: Scatter Plot - Leave Time vs Duration
        function renderScatterChart(rides) {
            const insightsDiv = document.getElementById('scatterInsights');

            if (chartInstances.scatter) {
                chartInstances.scatter.destroy();
            }

            const morningRides = rides.filter(r => r.commuteType === 'morning');
            const eveningRides = rides.filter(r => r.commuteType === 'evening');

            const morningData = morningRides.map(r => ({
                x: r.leaveMinutes,
                y: r.durationMin,
                date: r.startLocal.toLocaleDateString('en-GB'),
                speed: r.avgSpeedKph.toFixed(1)
            }));

            const eveningData = eveningRides.map(r => ({
                x: r.leaveMinutes,
                y: r.durationMin,
                date: r.startLocal.toLocaleDateString('en-GB'),
                speed: r.avgSpeedKph.toFixed(1)
            }));

            chartInstances.scatter = new Chart(document.getElementById('scatterChart').getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Morning rides',
                            data: morningData,
                            backgroundColor: 'rgba(99, 91, 255, 0.6)',
                            borderColor: 'rgba(99, 91, 255, 1)',
                            borderWidth: 1,
                        },
                        {
                            label: 'Evening rides',
                            data: eveningData,
                            backgroundColor: 'rgba(46, 125, 50, 0.6)',
                            borderColor: 'rgba(46, 125, 50, 1)',
                            borderWidth: 1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { family: 'Inter', size: 11 }, color: '#697386', padding: 10, usePointStyle: true }
                        },
                        tooltip: {
                            backgroundColor: '#1a1f36',
                            titleFont: { family: 'Inter', weight: '600' },
                            bodyFont: { family: 'Inter' },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                title: ctx => ctx[0].raw.date,
                                label: ctx => [
                                    `Leave: ${formatTime(ctx.parsed.x)}`,
                                    `Duration: ${ctx.parsed.y.toFixed(1)} min`,
                                    `Speed: ${ctx.raw.speed} km/h`
                                ]
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Leave Time', font: { family: 'Inter', size: 12 }, color: '#697386' },
                            grid: { color: CHART_COLORS.gridLine },
                            border: { display: false },
                            ticks: {
                                font: { family: 'Inter', size: 11 },
                                color: CHART_COLORS.tick,
                                callback: value => formatTime(value)
                            }
                        },
                        y: {
                            title: { display: true, text: 'Duration (min)', font: { family: 'Inter', size: 12 }, color: '#697386' },
                            grid: { color: CHART_COLORS.gridLine },
                            border: { display: false },
                            ticks: { font: { family: 'Inter', size: 11 }, color: CHART_COLORS.tick },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Generate insights
            if (morningRides.length > 0) {
                // Find optimal leave time bucket
                const buckets = {};
                morningRides.forEach(r => {
                    const bucket = Math.floor(r.leaveMinutes / 15) * 15;
                    if (!buckets[bucket]) buckets[bucket] = [];
                    buckets[bucket].push(r.durationMin);
                });

                let bestBucket = null;
                let bestMedian = Infinity;
                Object.entries(buckets).forEach(([bucket, durations]) => {
                    if (durations.length >= 2) {
                        const median = durations.sort((a, b) => a - b)[Math.floor(durations.length / 2)];
                        if (median < bestMedian) {
                            bestMedian = median;
                            bestBucket = parseInt(bucket);
                        }
                    }
                });

                const overallMedian = morningRides.map(r => r.durationMin).sort((a, b) => a - b)[Math.floor(morningRides.length / 2)];
                const savings = (overallMedian - bestMedian).toFixed(0);

                if (bestBucket !== null && savings > 0) {
                    insightsDiv.innerHTML = `<div class="insight-item"><span class="insight-bullet teal"></span><span>Leaving around ${formatTime(bestBucket)} makes your commute ~${savings} mins quicker.</span></div>`;
                } else {
                    insightsDiv.innerHTML = '';
                }
            } else {
                insightsDiv.innerHTML = '';
            }
        }

        // CHART 3: Heatmap - Weekly Commute Pattern
        function renderHeatmap(rides) {
            const container = document.getElementById('heatmapContainer');
            const insightsDiv = document.getElementById('heatmapInsights');

            if (rides.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#8792a2;padding:20px;">No data available</p>';
                insightsDiv.innerHTML = '';
                return;
            }

            // Group by week and day
            const weekMap = {};
            rides.forEach(r => {
                if (!weekMap[r.yearWeekKey]) {
                    weekMap[r.yearWeekKey] = Array(7).fill(0);
                }
                weekMap[r.yearWeekKey][r.dayOfWeek]++;
            });

            // Get last 12 weeks
            const weeks = Object.keys(weekMap).sort().slice(-12);

            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            let html = '<div class="heatmap-header"><div></div>';
            dayNames.forEach(day => html += `<div>${day}</div>`);
            html += '</div>';

            weeks.forEach(week => {
                const weekLabel = week.replace('W', ' W');
                html += `<div class="heatmap-row"><div class="heatmap-week-label">${weekLabel}</div>`;

                weekMap[week].forEach((count, dayIdx) => {
                    const level = count === 0 ? 0 : count === 1 ? 1 : count <= 3 ? 2 : count <= 5 ? 3 : 4;
                    html += `<div class="heatmap-cell level-${level}" title="${dayNames[dayIdx]}, ${weekLabel}: ${count} rides"></div>`;
                });

                html += '</div>';
            });

            html += '<div class="heatmap-legend">Less <div class="heatmap-legend-item" style="background:#f0f3f7;"></div>';
            html += '<div class="heatmap-legend-item" style="background:#c8e6c9;"></div>';
            html += '<div class="heatmap-legend-item" style="background:#81c784;"></div>';
            html += '<div class="heatmap-legend-item" style="background:#4caf50;"></div>';
            html += '<div class="heatmap-legend-item" style="background:#2e7d32;"></div> More</div>';

            container.innerHTML = html;

            // Generate insights
            const dayCounts = [0, 0, 0, 0, 0, 0, 0];
            rides.forEach(r => dayCounts[r.dayOfWeek]++);
            const topDays = dayCounts
                .map((count, idx) => ({ day: dayNames[idx], count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 3)
                .filter(d => d.count > 0)
                .map(d => d.day);

            if (topDays.length > 0) {
                insightsDiv.innerHTML = `<div class="insight-item"><span class="insight-bullet green"></span><span>You mostly commute on ${topDays.join(', ')}.</span></div>`;
            } else {
                insightsDiv.innerHTML = '';
            }
        }

        // CHART 4: Speed Over Time with Rolling Average
        function renderSpeedOverTime(rides) {
            const insightsDiv = document.getElementById('speedInsights');

            if (chartInstances.speedTime) {
                chartInstances.speedTime.destroy();
            }

            const sorted = [...rides].sort((a, b) => a.startLocal - b.startLocal);

            const labels = sorted.map(r => r.startLocal.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
            const speeds = sorted.map(r => r.avgSpeedKph);

            // Calculate rolling average (14 rides)
            const rollingAvg = [];
            for (let i = 0; i < speeds.length; i++) {
                const start = Math.max(0, i - 13);
                const slice = speeds.slice(start, i + 1);
                const avg = slice.reduce((sum, v) => sum + v, 0) / slice.length;
                rollingAvg.push(avg);
            }

            chartInstances.speedTime = new Chart(document.getElementById('speedTimeChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Speed',
                            data: speeds,
                            borderColor: 'rgba(99, 91, 255, 0.3)',
                            backgroundColor: 'rgba(99, 91, 255, 0.05)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 2,
                            pointBackgroundColor: 'rgba(99, 91, 255, 0.5)',
                        },
                        {
                            label: '14-ride average',
                            data: rollingAvg,
                            borderColor: '#2e7d32',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { family: 'Inter', size: 11 }, color: '#697386', padding: 10, usePointStyle: true }
                        },
                        tooltip: {
                            backgroundColor: '#1a1f36',
                            titleFont: { family: 'Inter', weight: '600' },
                            bodyFont: { family: 'Inter' },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)} km/h`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            border: { display: false },
                            ticks: { font: { family: 'Inter', size: 11 }, color: CHART_COLORS.tick, maxRotation: 45 }
                        },
                        y: {
                            title: { display: true, text: 'Speed (km/h)', font: { family: 'Inter', size: 12 }, color: '#697386' },
                            grid: { color: CHART_COLORS.gridLine },
                            border: { display: false },
                            ticks: { font: { family: 'Inter', size: 11 }, color: CHART_COLORS.tick },
                            beginAtZero: false
                        }
                    }
                }
            });

            // Generate insights
            const latestAvg = rollingAvg[rollingAvg.length - 1];
            if (latestAvg) {
                insightsDiv.innerHTML = `<div class="insight-item"><span class="insight-bullet blue"></span><span>Your 14-ride average is holding steady at ${latestAvg.toFixed(1)} km/h.</span></div>`;
            } else {
                insightsDiv.innerHTML = '';
            }
        }

        function renderTable(rides) {
            const tbody = document.getElementById('commute-body');
            tbody.innerHTML = rides.map(r => {
                const date = r.startLocal.toLocaleDateString('en-GB', {
                    day: 'numeric', month: 'short', year: 'numeric'
                });
                const dist = r.distanceKm.toFixed(1) + ' km';
                const mins = Math.floor(r.durationSec / 60);
                const secs = r.durationSec % 60;
                const time = `${mins}m ${secs}s`;
                const speed = r.avgSpeedKph.toFixed(1) + ' km/h';
                const typeTag = `<span class="status-tag ${r.commuteType}">${r.commuteType.charAt(0).toUpperCase() + r.commuteType.slice(1)}</span>`;

                return `<tr>
                    <td>${date}</td>
                    <td>${r.name}</td>
                    <td>${dist}</td>
                    <td>${time}</td>
                    <td>${speed}</td>
                    <td>${typeTag}</td>
                </tr>`;
            }).join('');
        }

        // Auto-load on page load
        document.addEventListener('DOMContentLoaded', fetchCommutes);
    </script>
</body>
</html>
