<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swimming Pools in London</title>
    <link rel="icon" href="images/swimming_favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* CSS remains the same */
    </style>
</head>
<body>
    <div class="container">
        <div class="table-container">
            <div class="table-header">
                <h1>Swimming Pools in London</h1>
                <input type="text" id="search" placeholder="Search for pools..." onkeyup="filterPools()">
                <select id="type-filter" onchange="filterPools()">
                    <option value="all">All</option>
                    <option value="pool">Pool</option>
                    <option value="open_water">Open Water</option>
                </select>
            </div>
            <div class="scrollable-body">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Name</th>
                            <th onclick="sortTable(1)">Length (m)</th>
                            <th onclick="sortTable(2)">Borough</th>
                        </tr>
                    </thead>
                    <tbody id="pool-table-body">
                        <!-- Data will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
            <div id="popup-card" class="popup-card">
                <!-- Popup content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let lastFocusedMarker = null;
        let allMarkers = [];
        let dataRecords = [];

        const defaultZoomLevel = 12; // Default zoom level

        function initMap() {
            // Check if map is already initialized
            if (map !== undefined) {
                map.remove(); // Removes the existing map instance
            }

            map = L.map('map').setView([51.5074, -0.1278], defaultZoomLevel); // Create the map

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Custom icons for pool (default blue) and open water (green)
            const poolIcon = L.icon({
                iconUrl: 'images/map-marker-blue.png', // Path to the blue pool marker
                shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            const openWaterIcon = L.icon({
                iconUrl: 'images/map-marker-green.png', // Path to the green open water marker
                shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            const focusIcon = L.icon({
                iconUrl: 'images/map-marker-red.png', // Red marker for focus mode
                shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            fetch('/.netlify/functions/getPools')
                .then(response => response.json())
                .then(data => {
                    dataRecords = data.records; // Store the fetched data for later use

                    const tableBody = document.getElementById('pool-table-body');
                    tableBody.innerHTML = data.records.map(record => `
                        <tr data-id="${record.id}" data-type="${record.fields.Type.toLowerCase()}">
                            <td>${record.fields.Name}</td>
                            <td>${record.fields.Length}</td>
                            <td>${record.fields.Borough}</td>
                        </tr>
                    `).join('');

                    allMarkers = data.records.map(record => {
                        if (record.fields.Latitude && record.fields.Longitude) {
                            const type = record.fields.Type.toLowerCase();
                            const icon = type === 'open_water' ? openWaterIcon : poolIcon;

                            const marker = L.marker([record.fields.Latitude, record.fields.Longitude], { icon }).addTo(map);
                            marker.bindPopup(`<strong>${record.fields.Name}</strong><br>${record.fields.Borough}`);
                            marker.type = type; // Store type in the marker object for later use
                            marker.on('click', () => focusOnMarker(record.id));
                            return { id: record.id, marker };
                        }
                    }).filter(marker => marker);

                    markers = [...allMarkers];

                    // Default sort table A-Z
                    sortTable(0);

                    // Add click event to table rows
                    document.querySelectorAll('#pool-table-body tr').forEach(row => {
                        row.addEventListener('click', () => {
                            focusOnMarker(row.getAttribute('data-id'));
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });

            map.on('click', () => {
                if (lastFocusedMarker) {
                    const originalIcon = lastFocusedMarker.marker.type === 'open_water' ? openWaterIcon : poolIcon;
                    lastFocusedMarker.marker.setIcon(originalIcon);
                    lastFocusedMarker = null;
                    document.getElementById('popup-card').classList.remove('visible');
                    map.setView([51.5074, -0.1278], defaultZoomLevel); // Reset to default zoom level
                }
            });
        }

        function focusOnMarker(id) {
            if (lastFocusedMarker) {
                const originalIcon = lastFocusedMarker.marker.type === 'open_water' ? openWaterIcon : poolIcon;
                lastFocusedMarker.marker.setIcon(originalIcon);
            }

            let focusedMarker = markers.find(marker => marker.id === id);
            if (focusedMarker) {
                focusedMarker.marker.setIcon(focusIcon);
                map.setView(focusedMarker.marker.getLatLng(), 15);
                lastFocusedMarker = focusedMarker;

                const record = dataRecords.find(record => record.id === id);
                document.getElementById('popup-card').innerHTML = `
                    <h2>${record.fields.Name}</h2>
                    <p><strong>Length:</strong> ${record.fields.Length} meters</p>
                    <p><strong>Borough:</strong> ${record.fields.Borough}</p>
                    <p><strong>Address:</strong> ${record.fields.Address}</p>
                    <p><strong>Opening Hours:</strong> ${record.fields.Opening_Hours}</p>
                    <p><strong>Price (Non-member):</strong> ${record.fields.Price}</p>
                `;
                document.getElementById('popup-card').classList.add('visible');
            }
        }

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
