<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swim Plan Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://raw.githubusercontent.com/jpwoodi/swimtimeclac/2b6290fea10bcf90c5230f878fb3116be7d4e29a/people-2588747.jpg');
            background-size: cover;
            background-position: center;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            flex-direction: column;
        }

        .form-container {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            text-align: center;
            color: #212529;
            margin-bottom: 20px;
        }

        h1 {
            margin-bottom: 20px;
            color: #007BFF;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #343A40;
        }

        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            font-size: 1em;
        }

        .css-input {
            display: flex;
            gap: 10px;
        }

        .css-input input {
            width: 50%;
        }

        button {
            padding: 12px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .results-container {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 100%;
            padding: 20px;
            text-align: center;
            color: #212529;
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #007BFF;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Generate Your Swim Plan</h1>
        <form id="swim-plan-form">
            <div class="form-group">
                <label for="goal">Swim Goal</label>
                <input type="text" id="goal" name="goal" placeholder="E.g., Improve endurance, build speed">
            </div>
            <div class="form-group">
                <label for="cssMinutes">Critical Swim Speed</label>
                <div class="css-input">
                    <input type="number" id="cssMinutes" name="cssMinutes" placeholder="Minutes per 100m" min="0">
                    <input type="number" id="cssSeconds" name="cssSeconds" placeholder="Seconds per 100m" min="0" max="59">
                </div>
            </div>
            <div class="form-group">
                <label for="duration">Plan Duration (weeks)</label>
                <input type="number" id="duration" name="duration" placeholder="E.g., 4">
            </div>
            <div class="form-group">
                <label for="sessions">Number of Sessions per Week</label>
                <input type="number" id="sessions" name="sessions" placeholder="E.g., 3">
            </div>
            <div class="form-group">
                <label for="session-duration">Session Duration (minutes)</label>
                <input type="number" id="session-duration" name="session-duration" placeholder="E.g., 60">
            </div>
            <button type="button" onclick="generateSwimPlan()">Generate Plan</button>
        </form>

        <div class="form-group">
            <label for="comments">Add a Comment</label>
            <textarea id="comments" name="comments" placeholder="E.g., Make the sessions longer" rows="3"></textarea>
        </div>
        <button type="button" onclick="addComment()">Add Comment and Regenerate Plan</button>
    </div>

    <div class="results-container" id="results-container">
        <table id="swim-plan-table">
            <!-- Table content will be dynamically inserted here -->
        </table>
    </div>

    <script>
        let swimPlans = [];  // Store the entire swim plan here
        let conversationHistory = [];  // To store the conversation history with OpenAI

        // Function to generate the swim plan based on initial input
        async function generateSwimPlan() {
            const goal = document.getElementById('goal').value;
            const cssMinutes = document.getElementById('cssMinutes').value;
            const cssSeconds = document.getElementById('cssSeconds').value;
            const duration = document.getElementById('duration').value;
            const sessions = document.getElementById('sessions').value;
            const sessionDuration = document.getElementById('session-duration').value;
            const resultsContainer = document.getElementById('results-container');

            if (!goal || !cssMinutes || !cssSeconds || !duration || !sessions || !sessionDuration) {
                alert("Please fill out all fields.");
                return;
            }

            // Initial plan generation, no feedback yet
            await fetchAndDisplayPlan({
                goal,
                cssMinutes,
                cssSeconds,
                duration,
                sessions,
                sessionDuration,
                comments: "",  // No comments initially
                conversationHistory: []  // Start with an empty conversation history
            });
        }

        // Function to regenerate the plan based on user's comment
        async function addComment() {
            const comments = document.getElementById('comments').value;

            if (!comments.trim()) {
                alert("Please enter a comment to modify the plan.");
                return;
            }

            // Use the stored conversation history and send the comment for regenerating the plan
            await fetchAndDisplayPlan({
                conversationHistory,  // Send the conversation history to keep the context
                comments
            });
        }

        // Function to fetch the swim plan from the backend and display it
        async function fetchAndDisplayPlan(details) {
            try {
                const response = await fetch('/.netlify/functions/generateSwimPlan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(details)  // Pass the plan details and feedback
                });

                const data = await response.json();

                if (response.ok) {
                    const planText = data.plan;
                    swimPlans = parseSwimPlan(planText);  // Parse the plan into weeks
                    displayAllWeeks();  // Display the updated swim plan

                    // Update conversation history with the latest state from the backend
                    conversationHistory = data.conversationHistory;

                    document.getElementById('results-container').style.display = 'block';  // Show the results container
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            }
        }

        // Function to parse the plan and prepare it for display
        function parseSwimPlan(planText) {
            const weeklyPlans = [];
            const lines = planText.split('\n').filter(line => line.trim() !== '');

            let currentWeekNumber = null;
            let currentWeekSessions = [];

            lines.forEach((line, index) => {
                // Skip the header lines
                if (index < 2) return;

                const parts = line.split('|').map(part => part.trim()).filter(part => part !== '');

                if (parts.length === 7) {
                    const [weekStr, sessionStr, ...sessionData] = parts;
                    const weekNumber = parseInt(weekStr);
                    const sessionNumber = parseInt(sessionStr);

                    // Check if we're still on the same week
                    if (currentWeekNumber !== weekNumber) {
                        // If not the first week, push the previous week's data
                        if (currentWeekNumber !== null) {
                            weeklyPlans.push({
                                weekNumber: currentWeekNumber,
                                sessions: currentWeekSessions
                            });
                        }
                        // Start collecting sessions for the new week
                        currentWeekNumber = weekNumber;
                        currentWeekSessions = [];
                    }

                    currentWeekSessions.push({
                        sessionNumber: sessionNumber,
                        sessionData: sessionData
                    });
                } else {
                    console.error("Unexpected parts length:", parts);
                }
            });

            // Push the last week's data
            if (currentWeekNumber !== null) {
                weeklyPlans.push({
                    weekNumber: currentWeekNumber,
                    sessions: currentWeekSessions
                });
            }

            return weeklyPlans;
        }

        // Function to display all weeks and sessions in a table
        function displayAllWeeks() {
            const table = document.getElementById('swim-plan-table');
            let tableContent = `
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Session Number</th>
                        <th>Warm Up</th>
                        <th>Build Set</th>
                        <th>Main Set</th>
                        <th>Cool Down</th>
                        <th>Total Distance</th>
                    </tr>
                </thead>
                <tbody>
            `;

            swimPlans.forEach((weekData) => {
                weekData.sessions.forEach((session) => {
                    const sessionNumber = session.sessionNumber;
                    const sessionDetails = session.sessionData; // Should be an array of 5 elements

                    if (sessionDetails.length === 5) {
                        tableContent += `
                            <tr>
                                <td>Week ${weekData.weekNumber}</td>
                                <td>Session ${sessionNumber}</td>
                                <td>${sessionDetails[0]}</td>
                                <td>${sessionDetails[1]}</td>
                                <td>${sessionDetails[2]}</td>
                                <td>${sessionDetails[3]}</td>
                                <td>${sessionDetails[4]}</td>
                            </tr>
                        `;
                    } else {
                        console.error("Unexpected sessionDetails length:", sessionDetails);
                    }
                });
            });

            tableContent += `</tbody>`;
            table.innerHTML = tableContent;
        }
    </script>
</body>
</html>

